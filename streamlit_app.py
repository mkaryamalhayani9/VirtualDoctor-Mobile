import streamlit as st
import math
import pandas as pd
from streamlit_js_eval import get_geolocation

# --- 1. ุฅุนุฏุงุฏุงุช ุงูุชุตููู ุงูุงุญุชุฑุงูู (AI Doctor ๐ฉบ) ---
st.set_page_config(page_title="AI Doctor ๐ฉบ", layout="wide")

st.markdown(r'''
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    * { font-family: 'Tajawal', sans-serif; direction: rtl; }
    .stApp { background-color: #050505; color: #e0e0e0; }
    .classic-logo { color: #40E0D0; text-align: center; font-size: 45px; font-weight: bold; margin-bottom: 25px; }
    .auth-box { max-width: 500px; margin: auto; padding: 30px; background: #0d0d0d; border-radius: 20px; border: 1px solid #40E0D0; box-shadow: 0 0 15px rgba(64,224,208,0.2); }
    .doc-card { background-color: #0d0d0d; padding: 20px; border-radius: 15px; border-right: 6px solid #40E0D0; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
    .stars { color: #FFD700; font-size: 20px; display: block; margin-bottom: 5px; }
    .emergency-box { background-color: #4a0000; color: #ff4b4b; padding: 18px; border-radius: 12px; border: 2px solid #ff4b4b; text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
    .stButton>button { background: linear-gradient(135deg, #1d4e4a 0%, #40E0D0 100%) !important; color: #000 !important; font-weight: bold; border-radius: 8px; width: 100%; height: 45px; border: none; }
    </style>
    ''', unsafe_allow_html=True)

# --- 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูููุณุนุฉ (30 ุนุฑุถ + ุฃุทุจุงุก ูุซุฑ) ---
SYMPTOMS_DB = {
    # ุญุงูุงุช ุทูุงุฑุฆ (Urgency >= 9)
    "ุฃูู ุตุฏุฑ ุญุงุฏ ูููุงุฌุฆ": {"spec": "ููุจูุฉ", "urg": 10, "diag": "๐จ ุงุดุชุจุงู ุฐุจุญุฉ ุตุฏุฑูุฉ - ุงุชุตู ุจุงูุฅุณุนุงู ููุฑุงู"},
    "ุตุนูุจุฉ ูู ุงูููุงู ุฃู ูููุงู ุงููุฌู": {"spec": "ุฌููุฉ ุนุตุจูุฉ", "urg": 10, "diag": "๐จ ุงุดุชุจุงู ุณูุชุฉ ุฏูุงุบูุฉ - ุชูุฌู ูุฃูุฑุจ ูุณุชุดูู"},
    "ุถูู ุชููุณ ุญุงุฏ ูุงุฒุฑูุงู": {"spec": "ุตุฏุฑูุฉ", "urg": 10, "diag": "๐จ ูุดู ุชููุณู ุญุงุฏ - ูุญุชุงุฌ ุฃูุณุฌูู ููุฑุงู"},
    "ุฃูู ุดุฏูุฏ ุฃุณูู ุงูุจุทู ุฌูุฉ ุงููููู": {"spec": "ุฌุฑุงุญุฉ ุนุงูุฉ", "urg": 9, "diag": "๐จ ุงุดุชุจุงู ุงูุชูุงุจ ุฒุงุฆุฏุฉ ุฏูุฏูุฉ ุญุงุฏ"},
    "ููุฏุงู ุฑุคูุฉ ููุงุฌุฆ ูู ุนูู ูุงุญุฏุฉ": {"spec": "ุนููู", "urg": 9, "diag": "๐จ ุทูุงุฑุฆ ุนููู - ุงุดุชุจุงู ุงููุตุงู ุดุจููุฉ"},
    "ุชุดูุฌ ุจุงูุฑูุจุฉ ูุน ุญุฑุงุฑุฉ ุนุงููุฉ": {"spec": "ุจุงุทููุฉ", "urg": 10, "diag": "๐จ ุงุดุชุจุงู ุงูุชูุงุจ ุณุญุงูุง - ุทูุงุฑุฆ ูุตูู"},
    "ูุฒูู ุฃูู ูุง ูุชููู": {"spec": "ุฃุฐู ูุญูุฌุฑุฉ", "urg": 9, "diag": "๐จ ุฑุนุงู ุญุงุฏ - ูุญุชุงุฌ ุชุฏุงุฎู ุทุจู"},
    "ูุณุฑ ุนุธูู ูุงุถุญ": {"spec": "ุนุธุงู", "urg": 9, "diag": "๐จ ูุณุฑ ุนุธูู - ูุญุชุงุฌ ุชุซุจูุช ูุฃุดุนุฉ"},
    "ุงุตูุฑุงุฑ ุดุฏูุฏ ุจุงูุนูู ูุงูุฌูุฏ": {"spec": "ูุจุฏ ูุจุงุทููุฉ", "urg": 9, "diag": "๐จ ูุตูุฑ ูุจุฏู ุญุงุฏ ุฃู ุงูุชูุงุจ ูุจุฏ ููุฑูุณู"},
    
    # ุญุงูุงุช ุนุงูุฉ ูุชุฎุตุตูุฉ
    "ุตุฏุงุน ูุตูู ูุชูุฑุฑ": {"spec": "ุฌููุฉ ุนุตุจูุฉ", "urg": 5, "diag": "ููุจุฉ ุดูููุฉ (ุตุฏุงุน ูุตูู)"},
    "ุนุทุด ูุฌูุน ููุฑุท ูุน ูุซุฑุฉ ุชุจูู": {"spec": "ุบุฏุฏ ุตูุงุก", "urg": 6, "diag": "ุงุดุชุจุงู ุงุถุทุฑุงุจ ูู ุณูุฑ ุงูุฏู"},
    "ุฃูู ุญุงุฏ ูู ุงูุฎุงุตุฑุฉ ููุชุฏ ููุธูุฑ": {"spec": "ูุณุงูู ุจูููุฉ", "urg": 8, "diag": "ุงุดุชุจุงู ูุฌูุฏ ุญุตู ูู ุงููููุฉ"},
    "ุทูุญ ุฌูุฏู ูุญูุฉ ุดุฏูุฏุฉ": {"spec": "ุฌูุฏูุฉ", "urg": 4, "diag": "ุญุณุงุณูุฉ ุฌูุฏูุฉ ุฃู ุงูุฒููุง"},
    "ุฏูุงุฑ ูุทููู ูู ุงูุฃุฐู": {"spec": "ุฃุฐู ูุญูุฌุฑุฉ", "urg": 5, "diag": "ุงุถุทุฑุงุจ ูู ุงูุฃุฐู ุงูุฏุงุฎููุฉ"},
    "ุฃูู ูู ุงูุถุฑูุณ ููุฒูู ูุซุฉ": {"spec": "ุฃุณูุงู", "urg": 4, "diag": "ุงูุชูุงุจ ูุซุฉ ุฃู ุชุณูุณ ุนููู"},
    "ุฎููู ุฏุงุฆู ูุชุณุงูุท ุดุนุฑ": {"spec": "ุบุฏุฏ ุตูุงุก", "urg": 5, "diag": "ุงุดุชุจุงู ุฎููู ุงูุบุฏุฉ ุงูุฏุฑููุฉ"},
    "ุฃูู ูุชูุจุณ ูู ุงูููุงุตู ุตุจุงุญุงู": {"spec": "ููุงุตู", "urg": 5, "diag": "ุงุดุชุจุงู ุงูุชูุงุจ ููุงุตู ุฑููุงุชูุฒูู"},
    "ุญููุถุฉ ูุญุฑูุฉ ูู ุงููุฑูุก": {"spec": "ุฌูุงุฒ ูุถูู", "urg": 4, "diag": "ุงุฑุชุฌุงุน ูุฑูุฆู (ุญููุถุฉ ุงููุนุฏุฉ)"},
    "ุฑุนุดุฉ ุบูุฑ ุฅุฑุงุฏูุฉ ูู ุงููุฏ": {"spec": "ุฌููุฉ ุนุตุจูุฉ", "urg": 6, "diag": "ุงุถุทุฑุงุจ ุนุตุจู ุญุฑูู"},
    "ุณุนุงู ุฌุงู ููุณุชูุฑ": {"spec": "ุตุฏุฑูุฉ", "urg": 5, "diag": "ุชุญุณุณ ูุตุจู ุฃู ุฑุจู"},
    "ุชูุฑู ูุฃูู ูู ุฑุจูุฉ ุงูุณุงู": {"spec": "ุฃูุนูุฉ ุฏูููุฉ", "urg": 8, "diag": "ุงุดุชุจุงู ุฌูุทุฉ ูุฑูุฏูุฉ - ุชุฌูุจ ุงูุญุฑูุฉ ุงููุซูุฑุฉ"},
    "ุญุฒู ุฏุงุฆู ูููุฏุงู ุดุบู": {"spec": "ููุณูุฉ", "urg": 5, "diag": "ุฃุนุฑุงุถ ุงูุชุฆุงุจ ุณุฑูุฑู"},
    "ุชุฃุฎุฑ ูู ุงููุทู ุนูุฏ ุงูุทูู": {"spec": "ุฃุทูุงู", "urg": 4, "diag": "ุงุถุทุฑุงุจ ููู ูุบูู"},
    "ุญุฑูุฉ ุดุฏูุฏุฉ ุนูุฏ ุงูุชุจูู": {"spec": "ูุณุงูู ุจูููุฉ", "urg": 5, "diag": "ุงูุชูุงุจ ูุฌุงุฑู ุจูููุฉ"},
    "ุฌูุงู ูุญุฑูุฉ ูู ุงูุนูู": {"spec": "ุนููู", "urg": 3, "diag": "ุฌูุงู ููุชุญูุฉ ุงูุนูู"},
    "ุชุณุงูุท ุดุนุฑ ูุฑุงุบู (ุซุนูุจุฉ)": {"spec": "ุฌูุฏูุฉ", "urg": 4, "diag": "ูุฑุถ ุงูุซุนูุจุฉ ุฃู ุถุนู ููุงุนู"},
    "ุฃูู ุฃุฐู ููุงุฌุฆ ุนูุฏ ุงูุฃุทูุงู": {"spec": "ุฃุฐู ูุญูุฌุฑุฉ", "urg": 6, "diag": "ุงูุชูุงุจ ุฃุฐู ูุณุทู"},
    "ุชูููู ูู ุฃุทุฑุงู ุงูุฃุตุงุจุน": {"spec": "ุฌููุฉ ุนุตุจูุฉ", "urg": 5, "diag": "ุงุนุชูุงู ุฃุนุตุงุจ ุทุฑููุฉ"},
    "ุบุงุฒุงุช ูุงูุชูุงุฎ ุจุทู ุฏุงุฆู": {"spec": "ุฌูุงุฒ ูุถูู", "urg": 3, "diag": "ููููู ุนุตุจู"},
    "ููุต ููุชุงูููุงุช ูุดุญูุจ": {"spec": "ุจุงุทููุฉ", "urg": 4, "diag": "ููุฑ ุฏู ุฃู ููุต ููุชุงููู D/B12"}
}

DOCTORS_DB = [
    {"name": "ุฏ. ุนูู ุงูุฑูุงุจู", "spec": "ููุจูุฉ", "area": "ุงูุญุงุฑุซูุฉ", "lat": 33.322, "lon": 44.358, "stars": 5},
    {"name": "ุฏ. ูุญูุฏ ุงูุฒูุฏู", "spec": "ููุจูุฉ", "area": "ุงูููุตูุฑ", "lat": 33.324, "lon": 44.345, "stars": 5},
    {"name": "ุฏ. ุณุงุฑุฉ ุงููุงุฆูู", "spec": "ููุจูุฉ", "area": "ุงููุฑุงุฏุฉ", "lat": 33.315, "lon": 44.425, "stars": 5},
    {"name": "ุฏ. ุนูุฑ ุงูุฌุจูุฑู", "spec": "ุฌููุฉ ุนุตุจูุฉ", "area": "ุงูููุตูุฑ", "lat": 33.325, "lon": 44.348, "stars": 5},
    {"name": "ุฏ. ุญูุฏุฑ ุงููุฒูููู", "spec": "ุฌููุฉ ุนุตุจูุฉ", "area": "ุงูุญุงุฑุซูุฉ", "lat": 33.321, "lon": 44.357, "stars": 5},
    {"name": "ุฏ. ูุงุณููู ุทู", "spec": "ุนููู", "area": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.280, "lon": 44.390, "stars": 5},
    {"name": "ุฏ. ูุคู ุงูุฎูุงุฌู", "spec": "ุนููู", "area": "ุงููุฑููู", "lat": 33.300, "lon": 44.330, "stars": 5},
    {"name": "ุฏ. ูุฑูู ุงูููุณู", "spec": "ููุงุตู", "area": "ุงููุฑุงุฏุฉ", "lat": 33.313, "lon": 44.429, "stars": 4},
    {"name": "ุฏ. ุฃุญูุฏ ุงูุนุฒุงูู", "spec": "ุฌุฑุงุญุฉ ุนุงูุฉ", "area": "ุงูููุตูุฑ", "lat": 33.326, "lon": 44.340, "stars": 5},
    {"name": "ุฏ. ุฒููุฉ ุงูุญุณูู", "spec": "ุฌูุฏูุฉ", "area": "ุฒูููุฉ", "lat": 33.340, "lon": 44.450, "stars": 5},
    {"name": "ุฏ. ุญุณู ุงููุงุดูู", "spec": "ูุณุงูู ุจูููุฉ", "area": "ุงูุญุงุฑุซูุฉ", "lat": 33.320, "lon": 44.355, "stars": 5},
    {"name": "ุฏ. ุฑูุง ุงูุชูููู", "spec": "ุฃุทูุงู", "area": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.285, "lon": 44.395, "stars": 5},
    {"name": "ุฏ. ูุตุทูู ููุงู", "spec": "ุฃุฐู ูุญูุฌุฑุฉ", "area": "ุงููุฑููู", "lat": 33.305, "lon": 44.335, "stars": 5},
    {"name": "ุฏ. ุณุนุงุฏ ุงูุญุฏูุซู", "spec": "ุบุฏุฏ ุตูุงุก", "area": "ุงูููุตูุฑ", "lat": 33.323, "lon": 44.342, "stars": 5},
    {"name": "ุฏ. ููุงุฑ ุงูุฑุจูุนู", "spec": "ุตุฏุฑูุฉ", "area": "ุงูุญุงุฑุซูุฉ", "lat": 33.321, "lon": 44.359, "stars": 5}
]

# --- 3. ุงูุชูููุฐ ---
if "logged_in" not in st.session_state: st.session_state.logged_in = False

st.markdown('<div class="classic-logo">AI Doctor ๐ฉบ</div>', unsafe_allow_html=True)

if not st.session_state.logged_in:
    st.markdown('<div class="auth-box">', unsafe_allow_html=True)
    st.subheader("ุชุณุฌูู ุจูุงูุงุช ุงููุฑูุถ")
    p_name = st.text_input("ุงูุฃุณู ุงููุงูู")
    p_age = st.number_input("ุงูุนูุฑ", 1, 110, 25)
    if st.button("ุฏุฎูู ูููุธุงู"):
        if p_name:
            st.session_state.logged_in = True
            st.session_state.p_name = p_name
            st.session_state.p_age = p_age
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

else:
    u_loc = get_geolocation()
    st.write(f"ูุฑุญุจุงู ุจู: *{st.session_state.p_name}* | ุงูุนูุฑ: *{st.session_state.p_age}* ุนุงูุงู")
    
    selected_symptom = st.selectbox("ุจูุงุฐุง ุชุดุนุฑุ (ุงุฎุชุฑ ูู ูุงุฆูุฉ ุงูู 30 ุนุฑุถุงู)", ["ุงุฎุชุฑ ุญุงูุชู..."] + list(SYMPTOMS_DB.keys()))

    if selected_symptom != "ุงุฎุชุฑ ุญุงูุชู...":
        case = SYMPTOMS_DB[selected_symptom]
        
        if case['urg'] >= 9:
            st.markdown(f'<div class="emergency-box">{case["diag"]}</div>', unsafe_allow_html=True)
        else:
            st.success(f"๐ค ุงูุชุดุฎูุต ุงูููุชุฑุญ: {case['diag']}")

        # ููุชุฑุฉ ูุญุณุงุจ ูุณุงูุฉ
        matched = [d for d in DOCTORS_DB if d['spec'] == case['spec']]
        
        u_lat, u_lon = 33.333, 44.400 # ูุฑูุฒ ุจุบุฏุงุฏ ุงูุงูุชุฑุงุถู
        if u_loc and 'coords' in u_loc:
            clat, clon = u_loc['coords'].get('latitude'), u_loc['coords'].get('longitude')
            if clat and clon: u_lat, u_lon = clat, clon
        
        for d in matched:
            d['dist'] = round(math.sqrt((u_lat - d['lat'])*2 + (u_lon - d['lon'])*2) * 111, 1)
        
        matched = sorted(matched, key=lambda x: x['dist'])

        st.subheader(f"๐ ุฃูุถู ุฃุทุจุงุก {case['spec']} ุงููุฑูุจูู ููู:")
        
        if not matched:
            st.warning("ุนุฐุฑุงูุ ูู ูุชู ุงูุนุซูุฑ ุนูู ุทุจูุจ ูู ูุฐุง ุงูุชุฎุตุต ุถูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ.")

        for d in matched:
            with st.container():
                st.markdown(f'''<div class="doc-card">
                    <span style="color:#40E0D0; font-size:22px; font-weight:bold;">{d['name']}</span>
                    <div class="stars">{"โญ"*d['stars']}</div>
                    <p>๐ {d['area']} | ๐ ูุจุนุฏ ุนูู {d['dist']} ูู ุชูุฑูุจุงู</p></div>''', unsafe_allow_html=True)
                
                show_map = st.checkbox(f"ุชุญุฏูุฏ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ ูู {d['name']} ๐บ๏ธ", key=f"m_{d['name']}")
                if show_map:
                    st.map(pd.DataFrame({'lat': [d['lat']], 'lon': [d['lon']]}), zoom=14)
                
                if st.button(f"ุชุฃููุฏ ุญุฌุฒ ุงูููุนุฏ ุนูุฏ {d['name']}", key=f"b_{d['name']}"):
                    st.balloons()
                    st.success(f"ุชู ุงูุญุฌุฒ ุจูุฌุงุญ ูุง {st.session_state.p_name}! ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู.")
