import streamlit as st
import math
import pandas as pd
from datetime import datetime
from streamlit_js_eval import get_geolocation

# --- 1. ุงูุฅุนุฏุงุฏุงุช ูุงูุชูุณูู ุงูุจุตุฑู ุงููุงุฎุฑ ---
st.set_page_config(page_title="AI Doctor ๐ฉบ Baghdad", layout="wide")

st.markdown(r'''
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    * { font-family: 'Tajawal', sans-serif; direction: rtl; }
    .stApp { background-color: #050505; color: #e0e0e0; }
    .welcome-header { color: #40E0D0; text-align: center; font-size: 35px; font-weight: bold; padding: 15px; border-bottom: 2px solid #40E0D0; margin-bottom: 25px; }
    .emergency-box { background: linear-gradient(90deg, #800 0%, #b00 100%); color: white; padding: 20px; border-radius: 15px; border: 2px solid white; margin-bottom: 20px; text-align: center; }
    .doc-card { background-color: #0d0d0d; padding: 20px; border-radius: 15px; border-right: 8px solid #40E0D0; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
    .stars { color: #FFD700; font-size: 18px; }
    .dist-tag { color: #40E0D0; font-weight: bold; font-size: 16px; border: 1px solid #40E0D0; padding: 2px 8px; border-radius: 5px; }
    .success-panel { background: #0d0d0d; border: 3px solid #40E0D0; border-radius: 20px; padding: 40px; text-align: center; }
    </style>
    ''', unsafe_allow_html=True)

# --- 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุถุฎูุฉ (30 ุนุงุฑุถ + ุฃุทุจุงุก ุจุบุฏุงุฏ) ---
DATA = {
    "ุฃุทุจุงุก": [
        {"n": "ุฏ. ุนูู ุงูุฑูุงุจู", "s": "ููุจูุฉ", "a": "ุงูุญุงุฑุซูุฉ", "lat": 33.3222, "lon": 44.3585, "stars": 5},
        {"n": "ุฏ. ุณุงุฑุฉ ุงูุฌุจูุฑู", "s": "ููุจูุฉ", "a": "ุงูููุตูุฑ", "lat": 33.3251, "lon": 44.3482, "stars": 4},
        {"n": "ุฏ. ุนูุฑ ุงูุฎูุงุฌู", "s": "ุฌููุฉ ุนุตุจูุฉ", "a": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.2801, "lon": 44.3905, "stars": 5},
        {"n": "ุฏ. ุญูุฏุฑ ุนุจุงุณ", "s": "ุฌููุฉ ุนุตุจูุฉ", "a": "ุดุงุฑุน ุงููุบุฑุจ", "lat": 33.3550, "lon": 44.3800, "stars": 4},
        {"n": "ุฏ. ูุฑูู ุงูููุณู", "s": "ููุงุตู", "a": "ุงููุฑุงุฏุฉ", "lat": 33.3135, "lon": 44.4291, "stars": 5},
        {"n": "ุฏ. ุฅูุงุฏ ุงูุนุงูู", "s": "ููุงุตู", "a": "ุงููุฑููู", "lat": 33.3000, "lon": 44.3300, "stars": 4},
        {"n": "ุฏ. ุญุณู ุงููุงุดูู", "s": "ุจุงุทููุฉ", "a": "ุงูุฃุนุธููุฉ", "lat": 33.3652, "lon": 44.3751, "stars": 5},
        {"n": "ุฏ. ุฒููุฉ ุงูุญุณูู", "s": "ุฌูุฏูุฉ", "a": "ุฒูููุฉ", "lat": 33.3401, "lon": 44.4502, "stars": 5},
        {"n": "ุฏ. ูุคู ุงูุดูุฑู", "s": "ุฌูุฏูุฉ", "a": "ุงูููุตูุฑ", "lat": 33.3260, "lon": 44.3400, "stars": 4},
        {"n": "ุฏ. ููุงุฑ ุงูุฑุจูุนู", "s": "ุตุฏุฑูุฉ", "a": "ุดุงุฑุน ุงููุบุฑุจ", "lat": 33.3560, "lon": 44.3810, "stars": 5},
        {"n": "ุฏ. ุฑูุง ุงูุชูููู", "s": "ุฃุทูุงู", "a": "ุญู ุงูุฌุงูุนุฉ", "lat": 33.3100, "lon": 44.3100, "stars": 5},
        {"n": "ุฏ. ููุงู ุงูุฌุฑุงุญ", "s": "ุนุธุงู", "a": "ุณุงุญุฉ ุงููุงุซู", "lat": 33.3120, "lon": 44.4220, "stars": 5},
        {"n": "ุฏ. ูุงุณููู ุทู", "s": "ุนููู", "a": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.2810, "lon": 44.3910, "stars": 4},
        {"n": "ุฏ. ูุตุทูู ููุงู", "s": "ุฃุฐู ูุญูุฌุฑุฉ", "a": "ุงูููุตูุฑ", "lat": 33.3230, "lon": 44.3440, "stars": 5},
        {"n": "ุฏ. ุณุนุงุฏ ุงูุญุฏูุซู", "s": "ุบุฏุฏ ุตูุงุก", "a": "ุงูุญุงุฑุซูุฉ", "lat": 33.3210, "lon": 44.3590, "stars": 5}
    ],
    "ุฃุนุฑุงุถ": {
        "ุฃูู ุญุงุฏ ูููุงุฌุฆ ูู ุงูุตุฏุฑ": ("ููุจูุฉ", 10, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุฐุจุญุฉ ุตุฏุฑูุฉ - ุชูุฌู ูููุณุชุดูู ููุฑุงู"),
        "ุซูู ูู ุงูููุงู ูุฎุฏุฑ ุฌุงูุจู": ("ุฌููุฉ ุนุตุจูุฉ", 10, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุณูุชุฉ ุฏูุงุบูุฉ - ุงูููุช ุญุฑุฌ ุฌุฏุงู"),
        "ุถูู ุชููุณ ุญุงุฏ ูุงุฒุฑูุงู": ("ุตุฏุฑูุฉ", 10, "๐จ ุทูุงุฑุฆ: ูุดู ุชููุณู - ูุทููุจ ุฃููุณุฌูู ููุฑู"),
        "ุฃูู ุจุทู ูููู ุญุงุฏ ุฌุฏุงู": ("ุฌุฑุงุญุฉ ุนุงูุฉ", 9, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุงูุชูุงุจ ุฒุงุฆุฏุฉ ุฏูุฏูุฉ"),
        "ููุฏุงู ุฑุคูุฉ ููุงุฌุฆ": ("ุนููู", 9, "๐จ ุทูุงุฑุฆ ุนููู: ุงุญุชูุงู ุงููุตุงู ุดุจููุฉ"),
        "ุตุฏุงุน ุงููุฌุงุฑู ููุงุฌุฆ": ("ุฌููุฉ ุนุตุจูุฉ", 9, "๐จ ุทูุงุฑุฆ: ุงุญุชูุงู ูุฒู ุฏูุงุบู"),
        "ุฃูู ููู ุญุงุฏ ูุน ุฏู": ("ูุณุงูู ุจูููุฉ", 8, "ุงูุชุดุฎูุต: ูุบุต ููู ุญุงุฏ (ุงุญุชูุงู ุญุตู)"),
        "ุฏูุงุฑ ูุณุชูุฑ ูุทููู ุฃุฐู": ("ุฃุฐู ูุญูุฌุฑุฉ", 5, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ุชูุงุฒู ุจุงูุฃุฐู ุงูุฏุงุฎููุฉ"),
        "ุฃูู ููุงุตู ูุชูุจุณ ุตุจุงุญู": ("ููุงุตู", 5, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ููุงุตู ุฑููุงุชุฒูู"),
        "ุนุทุด ุดุฏูุฏ ูุชุจูู ูุชูุฑุฑ": ("ุบุฏุฏ ุตูุงุก", 5, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ุจูุณุชูู ุณูุฑ ุงูุฏู"),
        "ุฎููุงู ููุจ ููุช ุงูุฑุงุญุฉ": ("ููุจูุฉ", 7, "ุงูุชุดุฎูุต: ุชุณุงุฑุน ุถุฑุจุงุช ููุจ ูุญุชุงุฌ ุชุฎุทูุท"),
        "ุทูุญ ุฌูุฏู ุดุฏูุฏ ูุญูุฉ": ("ุฌูุฏูุฉ", 4, "ุงูุชุดุฎูุต: ุญุณุงุณูุฉ ุฌูุฏูุฉ ุญุงุฏุฉ"),
        "ุณุนุงู ุฌุงู ูุณุชูุฑ ูุฃุณุงุจูุน": ("ุตุฏุฑูุฉ", 5, "ุงูุชุดุฎูุต: ุชุญุณุณ ูุตุจู ุฃู ูุญุต ุตุฏุฑ"),
        "ุญุฑูุฉ ูุนุฏุฉ ุชุฒุฏุงุฏ ูููุงู": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ุงุฑุชุฌุงุน ูุฑูุฆู ุดุฏูุฏ"),
        "ุชูููู ูู ุงูุฃุทุฑุงู ุงููุณุชูุฑ": ("ุฌููุฉ ุนุตุจูุฉ", 5, "ุงูุชุดุฎูุต: ุงุนุชูุงู ุฃุนุตุงุจ ูุญูุทูุฉ"),
        "ูุฒู ูุซุฉ ูุฑุงุฆุญุฉ ูู": ("ุฃุณูุงู", 4, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ุฃูุณุฌุฉ ุญูู ุงูุณู"),
        "ุฎููู ุฏุงุฆู ููุนุงุณ": ("ุบุฏุฏ ุตูุงุก", 4, "ุงูุชุดุฎูุต: ุงุญุชูุงู ุฎููู ุบุฏุฉ ุฏุฑููุฉ"),
        "ุชุณุงูุท ุดุนุฑ ูุฑุงุบู ุฏุงุฆู": ("ุฌูุฏูุฉ", 4, "ุงูุชุดุฎูุต: ุฏุงุก ุงูุซุนูุจุฉ"),
        "ุฃูู ุฃุณูู ุงูุธูุฑ ูุน ุงูุณุงู": ("ููุงุตู", 5, "ุงูุชุดุฎูุต: ุงูุฒูุงู ุบุถุฑููู (ุนุฑู ุงููุณุง)"),
        "ุงุตูุฑุงุฑ ูู ุงูุนูู ูุงูุฌูุฏ": ("ุจุงุทููุฉ", 7, "ุงูุชุดุฎูุต: ูุฑูุงู - ุงูุชูุงุจ ูุจุฏ ููุฑูุณู"),
        "ุชูุฑู ุณุงู ูุงุญุฏุฉ ูุน ุฃูู": ("ุฃูุนูุฉ ุฏูููุฉ", 8, "๐จ ุชูุจูู: ุงุญุชูุงู ุฌูุทุฉ ูุฑูุฏูุฉ ุจุงูุณุงู"),
        "ุฑุนุดุฉ ูู ุงููุฏูู": ("ุฌููุฉ ุนุตุจูุฉ", 6, "ุงูุชุดุฎูุต: ุฑุนุงุด ุนุตุจู ุฃู ุจุงุฑููุณูู"),
        "ุฃูู ุฃุฐู ุญุงุฏ ูุฅูุฑุงุฒุงุช": ("ุฃุฐู ูุญูุฌุฑุฉ", 5, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ุฃุฐู ูุณุทู"),
        "ุฌูุงู ุนูู ูุญุฑูุงู": ("ุนููู", 3, "ุงูุชุดุฎูุต: ููุต ุฅูุฑุงุฒ ุงูุฏูุน"),
        "ููู ูููุจุงุช ุฐุนุฑ": ("ููุณูุฉ", 5, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ุงูููู ุงูุนุงู"),
        "ุญุฑุงุฑุฉ ูุฑุชูุนุฉ ูุง ุชูุฎูุถ": ("ุจุงุทููุฉ", 7, "ุงูุชุดุฎูุต: ุนุฏูู ุจูุชูุฑูุฉ ุญุงุฏุฉ"),
        "ุบุงุฒุงุช ูุงูุชูุงุฎ ุฏุงุฆู": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ููููู ุนุตุจู ูุธููู"),
        "ุชุฃุฎุฑ ูุทู ุนูุฏ ุทูู": ("ุฃุทูุงู", 4, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ููู ูุบูู"),
        "ูุฒู ุฃูู ูุชูุฑุฑ": ("ุฃุฐู ูุญูุฌุฑุฉ", 6, "ุงูุชุดุฎูุต: ุถุนู ุดุนูุฑุงุช ุฃูููุฉ"),
        "ุถุนู ุนุงู ูุดุญูุจ": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ููุฑ ุฏู ูุงุชุฌ ุนู ููุต ุญุฏูุฏ")
    }
}

# --- 3. ุงูุฏูุงู ุงูุจุฑูุฌูุฉ ---
def calculate_dist(lat1, lon1, lat2, lon2):
    try:
        return round(math.sqrt((lat1 - lat2)*2 + (lon1 - lon2)*2) * 111.13, 1)
    except: return 0.0

def is_open():
    h = datetime.now().hour
    return 15 <= h <= 21 # ุฏูุงู ุนูุงุฏุงุช ุจุบุฏุงุฏ

# --- 4. ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ---
st.markdown('<div class="welcome-header">AI Doctor ๐ฉบ - Baghdad</div>', unsafe_allow_html=True)

loc = get_geolocation()
u_lat, u_lon = 33.315, 44.366 # ุงูุชุฑุงุถู ูุฑูุฒ ุจุบุฏุงุฏ
if loc and 'coords' in loc:
    u_lat, u_lon = loc['coords']['latitude'], loc['coords']['longitude']

c1, c2, c3 = st.columns(3)
with c1: name = st.text_input("ุงูุฃุณู")
with c2: age = st.number_input("ุงูุนูุฑ", 1, 100, 25)
with c3: area = st.text_input("ุงูููุทูุฉ ุงูุญุงููุฉ", "ุจุบุฏุงุฏ")

st.divider()

sel = st.selectbox("ุตู ุฃุนุฑุงุถู ุจุฏูุฉ:", ["ุงุฎุชุฑ..."] + list(DATA["ุฃุนุฑุงุถ"].keys()))

if sel != "ุงุฎุชุฑ...":
    spec, urg, diag = DATA["ุฃุนุฑุงุถ"][sel]
    
    if urg >= 9:
        st.markdown(f'<div class="emergency-box"><h2>{diag}</h2><p>โ๏ธ ุฅุฎูุงุก ูุณุคูููุฉ: ุชูุฌู ููุทูุงุฑุฆ ููุฑุงูุ ูุฐุง ุชุดุฎูุต ุงุณุชุฑุดุงุฏู ููุท.</p></div>', unsafe_allow_html=True)
    else:
        st.info(f"๐ค ุงูุชุดุฎูุต ุงูููุชุฑุญ: {diag}")

    matches = [d for d in DATA["ุฃุทุจุงุก"] if d['s'] == spec]
    for d in matches: d['dist'] = calculate_dist(u_lat, u_lon, d['lat'], d['lon'])

    # ุงูุชุฑุชูุจ: ูุฌูู ูู ุงูุทูุงุฑุฆ / ูุฑุจ ูู ุงูุนุงุฏู
    matches = sorted(matches, key=lambda x: x['stars'] if urg >= 9 else x['dist'], reverse=(urg >= 9))

    st.subheader(f"๐ ุฃุทุจุงุก {spec} ุงููุชููุฑูู ูู ุจุบุฏุงุฏ:")
    
    status_txt = "๐ข ูุชุงุญ ููุฒูุงุฑุฉ" if is_open() else "๐ด ุงูุนูุงุฏุฉ ูุบููุฉ ุญุงููุงู"

    for d in matches:
        with st.container():
            st.markdown(f'''<div class="doc-card">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:22px; font-weight:bold; color:#40E0D0;">{d['n']}</span>
                    <span class="dist-tag">๐ {d['dist']} ูู</span>
                </div>
                <div class="stars">{"โญ" * d['stars']}</div>
                <p>๐ {d['a']} | {status_txt}</p>
            </div>''', unsafe_allow_html=True)
            
            if st.button(f"ุชุฃููุฏ ุงูุญุฌุฒ ุนูุฏ {d['n']}", key=d['n']):
                st.session_state.book = d
                st.session_state.uname = name
                st.session_state.page = "ok"
                st.rerun()

# --- 5. ุตูุญุฉ ุงููุฌุงุญ ---
if "page" in st.session_state and st.session_state.page == "ok":
    d = st.session_state.book
    st.markdown(f'''
        <div class="success-panel">
            <h1 style="color:#40E0D0;">โ ุชู ุญุฌุฒ ููุนุฏู ุจูุฌุงุญ</h1>
            <p style="font-size:20px;">ุงููุฑูุถ: <b>{st.session_state.uname}</b></p>
            <div style="background:#111; padding:20px; border-radius:15px; display:inline-block; margin-top:20px; border:1px solid #333;">
                <p>๐จโโ๏ธ ุงูุทุจูุจ: {d['n']}</p>
                <p>๐ ุงููููุน: {d['a']}</p>
                <p>๐ ุงููุณุงูุฉ: {d['dist']} ูู</p>
            </div>
            <p style="margin-top:20px; color:#888;">ูุชููู ูู ุงูุตุญุฉ ูุงูุณูุงูุฉ.</p>
        </div>
    ''', unsafe_allow_html=True)
    if st.button("ูุญุต ุนุงุฑุถ ุขุฎุฑ"):
        del st.session_state.page
        st.rerun()
