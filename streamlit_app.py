import streamlit as st
import math
from streamlit_js_eval import get_geolocation

# --- 1. ุงูุฅุนุฏุงุฏุงุช ูุงูุชูุณูู ุงูุจุตุฑู ุงููุงุฎุฑ ---
st.set_page_config(page_title="AI Doctor Baghdad", layout="centered")

st.markdown(r'''
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    * { font-family: 'Tajawal', sans-serif; direction: rtl; }
    .stApp { background-color: #050505; color: #e0e0e0; }
    .main-header { color: #40E0D0; text-align: center; font-size: 30px; margin-bottom: 30px; border-bottom: 2px solid #40E0D0; padding-bottom: 10px; }
    .disclaimer-box { background-color: #1a0000; color: #ff6666; padding: 20px; border: 2px solid #ff4b4b; border-radius: 12px; margin: 20px 0; text-align: center; line-height: 1.6; }
    .doc-card { background-color: #0d0d0d; padding: 20px; border-radius: 15px; border-right: 8px solid #40E0D0; margin-bottom: 15px; border: 1px solid #333; }
    .success-panel { border: 3px solid #40E0D0; border-radius: 20px; padding: 30px; text-align: center; background: #000; }
    .stButton>button { width: 100%; border-radius: 8px; font-weight: bold; }
    </style>
    ''', unsafe_allow_html=True)

# --- 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุชู ุงูุชุฏููู) ---
DATA = {
    "ุฃุทุจุงุก": [
        {"n": "ุฏ. ุนูู ุงูุฑูุงุจู", "s": "ููุจูุฉ", "desc": "ุงุณุชุดุงุฑู ูุณุทุฑุฉ ูุฃูุฑุงุถ ููุจ ูุนูุฏุฉ", "a": "ุงูุญุงุฑุซูุฉ", "lat": 33.3222, "lon": 44.3585, "stars": 5},
        {"n": "ุฏ. ุณุงุฑุฉ ุงูุฌุจูุฑู", "s": "ููุจูุฉ", "desc": "ุฃุฎุตุงุฆูุฉ ุฃูุฑุงุถ ุงูููุจ ูุงูุตูุงูุงุช", "a": "ุงูููุตูุฑ", "lat": 33.3251, "lon": 44.3482, "stars": 4},
        {"n": "ุฏ. ุนูุฑ ุงูุฎูุงุฌู", "s": "ุฌููุฉ ุนุตุจูุฉ", "desc": "ุฌุฑุงุญ ุฏูุงุบ ูููุฑุงุช - ุจูุฑุฏ ุนุฑุงูู", "a": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.2801, "lon": 44.3905, "stars": 5},
        {"n": "ุฏ. ุญูุฏุฑ ุนุจุงุณ", "s": "ุฌููุฉ ุนุตุจูุฉ", "desc": "ุฃุฎุตุงุฆู ุทุจ ุงูุฏูุงุบ ูุงูุฃุนุตุงุจ", "a": "ุดุงุฑุน ุงููุบุฑุจ", "lat": 33.3550, "lon": 44.3800, "stars": 4},
        {"n": "ุฏ. ูุฑูู ุงูููุณู", "s": "ููุงุตู", "desc": "ุฃุฎุตุงุฆูุฉ ุงูุฑููุงุชุฒู ูุญูู ุงูููุงุตู", "a": "ุงููุฑุงุฏุฉ", "lat": 33.3135, "lon": 44.4291, "stars": 5},
        {"n": "ุฏ. ุญุณู ุงููุงุดูู", "s": "ุจุงุทููุฉ", "desc": "ุฃุฎุตุงุฆู ุฃูุฑุงุถ ูุถููุฉ ููุจุฏ", "a": "ุงูุฃุนุธููุฉ", "lat": 33.3652, "lon": 44.3751, "stars": 5},
        {"n": "ุฏ. ุฒููุฉ ุงูุญุณูู", "s": "ุฌูุฏูุฉ", "desc": "ุฃุฎุตุงุฆูุฉ ุฃูุฑุงุถ ุงูุฌูุฏ ูุงูููุฒุฑ", "a": "ุฒูููุฉ", "lat": 33.3401, "lon": 44.4502, "stars": 5}
    ],
    "ุฃุนุฑุงุถ": {
        "ุฃูู ุญุงุฏ ูููุงุฌุฆ ูู ุงูุตุฏุฑ": ("ููุจูุฉ", 10, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุฐุจุญุฉ ุตุฏุฑูุฉ - ุชูุฌู ูููุณุชุดูู ููุฑุงู"),
        "ุซูู ูู ุงูููุงู ูุฎุฏุฑ ุฌุงูุจู": ("ุฌููุฉ ุนุตุจูุฉ", 10, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุณูุชุฉ ุฏูุงุบูุฉ"),
        "ุถูู ุชููุณ ุญุงุฏ ูุงุฒุฑูุงู": ("ุจุงุทููุฉ", 10, "๐จ ุทูุงุฑุฆ: ูุดู ุชููุณู"),
        "ุฃูู ุจุทู ูููู ุญุงุฏ ุฌุฏุงู": ("ุจุงุทููุฉ", 9, "๐จ ุทูุงุฑุฆ: ุงุดุชุจุงู ุงูุชูุงุจ ุฒุงุฆุฏุฉ ุฏูุฏูุฉ"),
        "ุตุฏุงุน ุงููุฌุงุฑู ููุงุฌุฆ": ("ุฌููุฉ ุนุตุจูุฉ", 9, "๐จ ุทูุงุฑุฆ: ุงุญุชูุงู ูุฒู ุฏูุงุบู"),
        "ุชูุฑู ุณุงู ูุงุญุฏุฉ ูุน ุฃูู": ("ุจุงุทููุฉ", 8, "ุชูุจูู: ุงุญุชูุงู ุฌูุทุฉ ูุฑูุฏูุฉ ุจุงูุณุงู"),
        "ุฎููุงู ููุจ ููุช ุงูุฑุงุญุฉ": ("ููุจูุฉ", 7, "ุงูุชุดุฎูุต: ุชุณุงุฑุน ุถุฑุจุงุช ููุจ ูุญุชุงุฌ ุชุฎุทูุท"),
        "ุงุตูุฑุงุฑ ูู ุงูุนูู ูุงูุฌูุฏ": ("ุจุงุทููุฉ", 7, "ุงูุชุดุฎูุต: ูุฑูุงู - ุงูุชูุงุจ ูุจุฏ ููุฑูุณู"),
        "ุญุฑุงุฑุฉ ูุฑุชูุนุฉ ูุง ุชูุฎูุถ": ("ุจุงุทููุฉ", 7, "ุงูุชุดุฎูุต: ุนุฏูู ุจูุชูุฑูุฉ ุญุงุฏุฉ"),
        "ุชุนุฑู ูููู ุดุฏูุฏ": ("ุจุงุทููุฉ", 7, "ุงูุชุดุฎูุต: ูุญุชุงุฌ ูุญูุตุงุช ุดุงููุฉ ููุนุฏูู"),
        "ุฑุนุดุฉ ูู ุงููุฏูู": ("ุฌููุฉ ุนุตุจูุฉ", 6, "ุงูุชุดุฎูุต: ุฑุนุงุด ุนุตุจู ุฃู ุจุงุฑููุณูู"),
        "ูุฒู ุฃูู ูุชูุฑุฑ": ("ุจุงุทููุฉ", 6, "ุงูุชุดุฎูุต: ุถุนู ุดุนูุฑุงุช ุฃูููุฉ"),
        "ููุฏุงู ุชูุงุฒู ุนูุฏ ุงููููู": ("ุฌููุฉ ุนุตุจูุฉ", 6, "ุงูุชุดุฎูุต: ุฏูุงุฑ ูุถุนู ุญููุฏ"),
        "ุฏูุงุฑ ูุณุชูุฑ ูุทููู ุฃุฐู": ("ุฌููุฉ ุนุตุจูุฉ", 5, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ุชูุงุฒู ุจุงูุฃุฐู ุงูุฏุงุฎููุฉ"),
        "ุฃูู ููุงุตู ูุชูุจุณ ุตุจุงุญู": ("ููุงุตู", 5, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ููุงุตู ุฑููุงุชุฒูู"),
        "ุชูููู ูู ุงูุฃุทุฑุงู ุงููุณุชูุฑ": ("ุฌููุฉ ุนุตุจูุฉ", 5, "ุงูุชุดุฎูุต: ุงุนุชูุงู ุฃุนุตุงุจ ูุญูุทูุฉ"),
        "ุฃูู ุฃุณูู ุงูุธูุฑ ูุน ุงูุณุงู": ("ููุงุตู", 5, "ุงูุชุดุฎูุต: ุงูุฒูุงู ุบุถุฑููู (ุนุฑู ุงููุณุง)"),
        "ุนุทุด ุดุฏูุฏ ูุชุจูู ูุชูุฑุฑ": ("ุจุงุทููุฉ", 5, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ุจูุณุชูู ุณูุฑ ุงูุฏู"),
        "ุณุนุงู ุฌุงู ูุณุชูุฑ": ("ุจุงุทููุฉ", 5, "ุงูุชุดุฎูุต: ุชุญุณุณ ูุตุจู"),
        "ุฃูู ุฃุฐู ุญุงุฏ ูุฅูุฑุงุฒุงุช": ("ุจุงุทููุฉ", 5, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ุฃุฐู ูุณุทู"),
        "ุทูุญ ุฌูุฏู ุดุฏูุฏ ูุญูุฉ": ("ุฌูุฏูุฉ", 4, "ุงูุชุดุฎูุต: ุญุณุงุณูุฉ ุฌูุฏูุฉ ุญุงุฏุฉ"),
        "ุญุฑูุฉ ูุนุฏุฉ ุชุฒุฏุงุฏ ูููุงู": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ุงุฑุชุฌุงุน ูุฑูุฆู"),
        "ุฎููู ุฏุงุฆู ููุนุงุณ": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ุงุญุชูุงู ุฎููู ุบุฏุฉ ุฏุฑููุฉ"),
        "ุบุงุฒุงุช ูุงูุชูุงุฎ ุฏุงุฆู": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ููููู ุนุตุจู ูุธููู"),
        "ุถุนู ุนุงู ูุดุญูุจ": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ููุฑ ุฏู (ููุต ุญุฏูุฏ)"),
        "ุชุณุงูุท ุดุนุฑ ูุฑุงุบู": ("ุฌูุฏูุฉ", 4, "ุงูุชุดุฎูุต: ุฏุงุก ุงูุซุนูุจุฉ"),
        "ูุฒูู ูุซุฉ ูุณุชูุฑ": ("ุจุงุทููุฉ", 4, "ุงูุชุดุฎูุต: ุงูุชูุงุจ ูุซุฉ"),
        "ุตุฏุงุน ูุฒูู ุฎูู ุงูุฑุฃุณ": ("ุฌููุฉ ุนุตุจูุฉ", 4, "ุงูุชุดุฎูุต: ุตุฏุงุน ุชูุชุฑู"),
        "ุฃูู ุงููู ุนูุฏ ุงููุถุบ": ("ููุงุตู", 4, "ุงูุชุดุฎูุต: ุงุถุทุฑุงุจ ููุตู ุงููู"),
        "ุฌูุงู ุนูู ูุญุฑูุงู": ("ุจุงุทููุฉ", 3, "ุงูุชุดุฎูุต: ููุต ุฅูุฑุงุฒ ุงูุฏูุน")
    }
}

# --- 3. ุฅุฏุงุฑุฉ ุงูุญุงูุฉ ---
if 'step' not in st.session_state: st.session_state.step = 1
if 'p_data' not in st.session_state: st.session_state.p_data = {}

def calculate_dist(lat1, lon1, lat2, lon2):
    if not lat1: return "ุฌุงุฑู ุฌูุจ ุงููููุน..."
    d = math.sqrt((lat1-lat2)*2 + (lon1-lon2)*2)*111.13
    return f"{d:.1f} ูู"

# --- 4. ูุธุงู ุงูุตูุญุงุช ุงููููุตูุฉ ---

# ุงูุตูุญุฉ 1: ูุนูููุงุช ุงููุฑูุถ
if st.session_state.step == 1:
    st.markdown('<div class="main-header">ุฎุทูุฉ 1: ูุนูููุงุช ุงููุฑูุถ ๐</div>', unsafe_allow_html=True)
    with st.form("p_info"):
        n = st.text_input("ุงูุฃุณู ุงููุงูู")
        a = st.number_input("ุงูุนูุฑ", 1, 100, 25)
        p = st.text_input("ุฑูู ุงููุงุชู")
        if st.form_submit_button("ุงุณุชูุฑุงุฑ"):
            if n and p:
                st.session_state.p_data = {"name": n, "age": a, "phone": p}
                st.session_state.step = 2
                st.rerun()
            else: st.error("ูุฑุฌู ููุก ุงูุจูุงูุงุช")

# ุงูุตูุญุฉ 2: ุงูุฃุนุฑุงุถ ูุงูุชุดุฎูุต ูุฅุฎูุงุก ุงููุณุคูููุฉ
elif st.session_state.step == 2:
    st.markdown('<div class="main-header">ุฎุทูุฉ 2: ูุญุต ุงูุฃุนุฑุงุถ ๐ค</div>', unsafe_allow_html=True)
    sel = st.selectbox("ุจูุงุฐุง ุชุดุนุฑุ", ["ุงุฎุชุฑ..."] + list(DATA["ุฃุนุฑุงุถ"].keys()))
    
    if sel != "ุงุฎุชุฑ...":
        spec, urg, diag = DATA["ุฃุนุฑุงุถ"][sel]
        st.session_state.selected_spec = spec
        st.info(f"*ุงูุชุญููู ุงูุฃููู:* {diag}")
        
        st.markdown(f'''
            <div class="disclaimer-box">
                โ๏ธ <b>ุฅุฎูุงุก ูุณุคูููุฉ ุทุจู</b> โ๏ธ<br>
                ูุฐุง ุงูุชุญููู ุงุณุชุฑุดุงุฏู ููุท ููุง ูุบูู ุนู ุงูุทุจูุจ ุงููุฎุชุต. <br>
                ูู ุญุงู ูุฌูุฏ ุทูุงุฑุฆ ุญุงุฏุฉุ ูุฑุฌู ุงูุงุชุตุงู ุจุงูุฅุณุนุงู (122) ููุฑุงู.
            </div>
        ''', unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("โฌ๏ธ ุฑุฌูุน"): st.session_state.step = 1; st.rerun()
        with col2:
            if st.button("ููุงููุ ุนุฑุถ ุงูุฃุทุจุงุก"): st.session_state.step = 3; st.rerun()

# ุงูุตูุญุฉ 3: ุงุฎุชูุงุฑ ุงูุทุจูุจ ูุงูููุนุฏ ุจุงูุณุงุนุฉ
elif st.session_state.step == 3:
    st.markdown(f'<div class="main-header">ุฎุทูุฉ 3: ุญุฌุฒ ุทุจูุจ {st.session_state.selected_spec} ๐ฉบ</div>', unsafe_allow_html=True)
    loc = get_geolocation()
    u_lat, u_lon = (loc['coords']['latitude'], loc['coords']['longitude']) if loc else (None, None)
    
    matches = [d for d in DATA["ุฃุทุจุงุก"] if d['s'] == st.session_state.selected_spec]
    
    if not matches:
        st.warning("ูุง ููุฌุฏ ุทุจูุจ ูุชุงุญ ููุฐุง ุงูุชุฎุตุต ุญุงููุงู.")
        if st.button("ุฑุฌูุน"): st.session_state.step = 2; st.rerun()
    else:
        for d in matches:
            dist = calculate_dist(u_lat, u_lon, d['lat'], d['lon'])
            st.markdown(f'''
                <div class="doc-card">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:22px; color:#40E0D0;"><b>{d['n']}</b></span>
                        <span style="color:#aaa;">๐ {dist}</span>
                    </div>
                    <div style="color:#FFD700;">{"โญ" * d['stars']}</div>
                    <div style="font-size:14px; margin: 8px 0; color:#eee;">{d['desc']}</div>
                    <div style="font-size:12px; color:#888;">๐ {d['a']}</div>
                </div>
            ''', unsafe_allow_html=True)
            
            times = [f"{h:02d}:00 PM" for h in range(4, 10)]
            t = st.selectbox(f"ุงุฎุชุฑ ููุนุฏุงู ุนูุฏ {d['n']}", times, key=f"t_{d['n']}")
            
            if st.button(f"ุชุฃููุฏ ุงูุญุฌุฒ {t}", key=f"b_{d['n']}"):
                st.session_state.final = {"doc": d['n'], "time": t, "area": d['a'], "spec": d['s']}
                st.session_state.step = 4
                st.rerun()
        
        if st.button("โฌ๏ธ ุงูุณุงุจู"): st.session_state.step = 2; st.rerun()

# ุงูุตูุญุฉ 4: ุงููุฌุงุญ ุงูููุงุฆู
elif st.session_state.step == 4:
    f = st.session_state.final
    p = st.session_state.p_data
    st.markdown(f'''
        <div class="success-panel">
            <h2 style="color:#40E0D0;">โ ุชู ุชุฃููุฏ ุงูุญุฌุฒ</h2>
            <p>ุงุณู ุงููุฑูุถ: <b>{p['name']}</b></p>
            <div style="background:#111; padding:20px; border-radius:15px; margin:20px 0; border:1px solid #40E0D0; text-align:right;">
                <p>๐จโโ๏ธ ุงูุทุจูุจ: {f['doc']}</p>
                <p>๐ฉบ ุงูุชุฎุตุต: {f['spec']}</p>
                <p>โฐ ุงูููุนุฏ: {f['time']}</p>
                <p>๐ ุงูุนููุงู: ุจุบุฏุงุฏ - {f['area']}</p>
            </div>
            <p style="color:#888; font-size:12px;">ุณูุตูู ุชุฃููุฏ ุนุจุฑ ุงูุฑูู: {p['phone']}</p>
        </div>
    ''', unsafe_allow_html=True)
    if st.button("ุญุฌุฒ ุฌุฏูุฏ"):
        st.session_state.step = 1
        st.rerun()
