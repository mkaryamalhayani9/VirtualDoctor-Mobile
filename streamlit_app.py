import streamlit as st
import math
from streamlit_js_eval import get_geolocation

# --- 1. ุงูุชูุณูู ูุงูุฌูุงููุฉ ---
st.set_page_config(page_title="AI Doctor Expert ๐ฉบ", layout="wide")

st.markdown(r'''
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    .stApp { direction: rtl; text-align: right; background-color: #050505; color: #e0e0e0; font-family: 'Tajawal', sans-serif; }
    .diag-card { background: rgba(64, 224, 208, 0.1); border: 1px solid #40E0D0; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
    .rec-card { background: #111; padding: 25px; border-radius: 15px; border: 2px solid #FFD700; }
    .locked-slot { background: #222 !important; color: #555 !important; border: 1px solid #333; padding: 8px; border-radius: 8px; text-align: center; font-size: 13px; }
    .star-rating { color: #FFD700; font-size: 20px; margin-bottom: 10px; }
    .stButton>button { background: #40E0D0 !important; color: black !important; font-weight: bold; border-radius: 10px; height: 50px; }
    .badge-rec { background: #FFD700; color: black; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; float: left; }
    </style>
    ''', unsafe_allow_html=True)

# --- 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุถุฎูุฉ (30 ุนุงุฑุถ + ุฃุทุจุงุก + ุฃููุงุช ููููุฉ) ---
DB = {
    "ุฃุทุจุงุก": [
        {"n": "ุฏ. ุนูู ุงูุฑูุงุจู", "s": "ููุจูุฉ", "a": "ุงูุญุงุฑุซูุฉ", "lat": 33.322, "lon": 44.358, "r": 5, "slots": {"09:00 ุต": "ok", "10:00 ุต": "locked", "11:00 ุต": "ok"}},
        {"n": "ุฏ. ุณุงุฑุฉ ุงููุงุฆูู", "s": "ููุจูุฉ", "a": "ุงูููุตูุฑ", "lat": 33.324, "lon": 44.340, "r": 4, "slots": {"04:00 ู": "ok", "05:00 ู": "locked"}},
        {"n": "ุฏ. ุนูุฑ ุงูุฌุจูุฑู", "s": "ุฃุนุตุงุจ", "a": "ุงูุฌุงุฏุฑูุฉ", "lat": 33.280, "lon": 44.395, "r": 5, "slots": {"11:00 ุต": "locked", "12:00 ู": "ok"}},
        {"n": "ุฏ. ูููู ุงูุจุงุทู", "s": "ุจุงุทููุฉ", "a": "ุงููุฑุงุฏุฉ", "lat": 33.310, "lon": 44.420, "r": 4, "slots": {"09:00 ุต": "ok", "10:00 ุต": "ok"}}
    ],
    "ุฃุนุฑุงุถ": {
        "ุฃูู ุตุฏุฑ ุญุงุฏ ูููุงุฌุฆ": ("ููุจูุฉ", "๐จ ุชุดุฎูุต ุงูุฐูุงุก: ุงุดุชุจุงู ุฐุจุญุฉ ุตุฏุฑูุฉ - ุงูุชุฑุดูุญ ููุฃูุฑุจ ููุฑุงู"),
        "ุซูู ูู ุงูููุงู": ("ุฃุนุตุงุจ", "๐จ ุชุดุฎูุต ุงูุฐูุงุก: ุงุดุชุจุงู ุณูุชุฉ ุฏูุงุบูุฉ - ุงูุชุฑุดูุญ ููุฃุณุฑุน ููุชุงู"),
        "ุถูู ุชููุณ ูุณุชูุฑ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุฃุฒูุฉ ุชููุณูุฉ ุญุงุฏุฉ"),
        "ุฎููุงู ููุจ ุณุฑูุน": ("ููุจูุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุถุทุฑุงุจ ูุธู ุงูููุจ"),
        "ุตุฏุงุน ูุตูู ุดุฏูุฏ": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ููุจุฉ ุดูููุฉ ุญุงุฏุฉ"),
        "ุงุตูุฑุงุฑ ุงูุนูู ูุงูุฌูุฏ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุถุทุฑุงุจ ูุธุงุฆู ุงููุจุฏ"),
        "ุฏูุงุฑ ูููุฏุงู ุชูุงุฒู": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุถุทุฑุงุจ ุงูุฃุฐู ุงูุฏุงุฎููุฉ"),
        "ุญุฑูุฉ ูุนุฏุฉ ูุฒููุฉ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุฑุชุฌุงุน ูุฑูุฆู"),
        "ุฃูู ุญุงุฏ ูู ุงูููุงุตู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงูุชูุงุจ ููุงุตู"),
        "ุทูุญ ุฌูุฏู ูุญูุฉ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุชุญุณุณ ุฌูุฏู"),
        "ุฑุคูุฉ ูุดูุดุฉ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุฅุฌูุงุฏ ุจุตุฑู ุดุฏูุฏ"),
        "ุชูููู ูู ุงูุฃุทุฑุงู": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุนุชูุงู ุฃุนุตุงุจ ุทุฑููุฉ"),
        "ุฃูู ุฃุณูู ุงูุธูุฑ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุชุดูุฌ ุนุถูู ุฃู ููู"),
        "ุณุนุงู ุฌุงู ูุณุชูุฑ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุชููุฌ ูู ุงููุตุจุงุช"),
        "ูุฒูู ูู ุงูุฃูู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุฌูุงู ุฃู ุถุบุท ุฏู"),
        "ุงูุชูุงุฎ ูู ุงููุฏููู": ("ููุจูุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุญุชุจุงุณ ุณูุงุฆู"),
        "ุฑุนุดุฉ ูู ุงููุฏูู": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ุฅุฌูุงุฏ ุนุตุจู"),
        "ูุดุฑุฉ ุฑุฃุณ ุญุงุฏุฉ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ูุทุฑูุงุช ูุฑูุฉ ุงูุฑุฃุณ"),
        "ุบุงุฒุงุช ูุงูุชูุงุฎ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ููููู ุนุตุจู"),
        "ุตุนูุจุฉ ูู ุงูุจูุน": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุชุดูุฌ ูุฑูุฆู"),
        "ุจูุน ุจูุถุงุก": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ููุต ุตุจุบุฉ"),
        "ุฎุฏุฑ ูู ุงููุฌู": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ุนุตุจ ุณุงุจุน"),
        "ุฃูู ุฎูู ุงูุนูู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุถุบุท ุนูู"),
        "ุชุนุฑู ูููู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุถุทุฑุงุจ ูุฑูููู"),
        "ุฃูู ุนูุฏ ุงูุชููุณ": ("ููุจูุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงูุชูุงุจ ุบุดุงุก ุงูููุจ"),
        "ูุดุงุดุฉ ุฃุธุงูุฑ": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ููุต ูุนุงุฏู"),
        "ุชุดูุฌ ุนุถูู ูููู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ููุต ูุบููุณููู"),
        "ุทููู ูู ุงูุฃุฐู": ("ุฃุนุตุงุจ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุถุทุฑุงุจ ุณูุนู"),
        "ุนุทุด ููุฑุท": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ุงุดุชุจุงู ุณูุฑ"),
        "ุชุนุจ ุนุงู ูุฎููู": ("ุจุงุทููุฉ", "ุชุดุฎูุต ุงูุฐูุงุก: ููุต ููุชุงูููุงุช")
    }
}

if "pg" not in st.session_state: st.session_state.pg = "main"

# --- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ---
if st.session_state.pg == "main":
    st.title("๐ฉบ ูุฑุดุญ ุงูุชุดุฎูุต ูุงูุญุฌุฒ ุงูุฐูู")
    
    # ุญุณุงุจ ุงููููุน
    u_loc = get_geolocation()
    lat, lon = 33.315, 44.366
    if u_loc and 'coords' in u_loc:
        lat, lon = u_loc['coords'].get('latitude'), u_loc['coords'].get('longitude')

    # ุงุฎุชูุงุฑ ุงูุนุงุฑุถ (30 ุนุงุฑุถุงู)
    sel = st.selectbox("ุจูุงุฐุง ุชุดุนุฑ ุงูุขูุ", ["ุงุฎุชุฑ ุงูุญุงูุฉ..."] + list(DB["ุฃุนุฑุงุถ"].keys()))

    if sel != "ุงุฎุชุฑ ุงูุญุงูุฉ...":
        spec, diag_text = DB["ุฃุนุฑุงุถ"][sel]
        st.markdown(f'<div class="diag-card">๐ค {diag_text}</div>', unsafe_allow_html=True)
        
        # ููุทู ุงูุชุฑุดูุญ (ุงูุฃูุฑุจ + ููุชุงู)
        matches = [d for d in DB["ุฃุทุจุงุก"] if d['s'] == spec]
        if matches:
            for d in matches:
                d['dist'] = math.sqrt(pow(lat - d['lat'], 2) + pow(lon - d['lon'], 2))
                d['free'] = any(v == "ok" for v in d['slots'].values())
            
            # ุงูุชุฑุดูุญ: ุงูุฃูุถู ูู ูู ูุฏูู ููุช ููุณุงูุฉ ุฃูุฑุจ
            best = sorted(matches, key=lambda x: (not x['free'], x['dist']))[0]

            st.subheader("๐ ุงูุทุจูุจ ุงููุฑุดุญ ูุญุงูุชู (ุงูุฃูุฑุจ ูุงูุฃุณุฑุน):")
            with st.container():
                stars = "โ" * best['r'] + "โ" * (5 - best['r'])
                st.markdown(f'''
                <div class="rec-card">
                    <span class="badge-rec">ุชุฑุดูุญ ุฐูู</span>
                    <div class="star-rating">{stars}</div>
                    <div style="font-size:24px; font-weight:bold; color:#40E0D0;">{best['n']}</div>
                    <p>๐ {best['a']} | ุชุฎุตุต {best['s']}</p>
                </div>
                ''', unsafe_allow_html=True)
                
                st.write("---")
                st.write("๐๏ธ *ุงุฎุชุฑ ููุนุฏ ุงูุญุฌุฒ (ุงููุญุฌูุฒ ุนููู ููู ๐):*")
                
                # ุนุฑุถ ุงูููุงุนูุฏ
                cols = st.columns(len(best['slots']))
                for idx, (t, status) in enumerate(best['slots'].items()):
                    with cols[idx]:
                        if status == "locked":
                            st.markdown(f'<div class="locked-slot">๐ {t}</div>', unsafe_allow_html=True)
                        else:
                            if st.button(f"๐๏ธ {t}", key=f"btn_{idx}"):
                                st.session_state.b_info = {"n": best['n'], "t": t, "a": best['a']}
                                st.session_state.pg = "done"
                                st.rerun()

# --- ุตูุญุฉ ุงูุญุฌุฒ ุงูููุงุฆู ---
elif st.session_state.pg == "done":
    st.balloons()
    b = st.session_state.b_info
    st.markdown(f'''
    <div style="text-align:center; padding:50px; border:2px solid #40E0D0; border-radius:20px; background:#111; margin-top:30px;">
        <h2 style="color:#40E0D0;">โ ุชู ุชุฃููุฏ ุงูุญุฌุฒ</h2>
        <p style="font-size:20px;">ุชู ุงุฎุชูุงุฑ ุงูููุนุฏ ุจูุฌุงุญ ุนูุฏ <b>{b['n']}</b></p>
        <p style="font-size:20px;">ุงูููุช: <b>{b['t']}</b> | ุงูููุงู: <b>{b['a']}</b></p>
        <br>
        <p style="color:#888;">ุงููุธุงู ูุงู ุจุชุฑุดูุญ ูุฐุง ุงูุทุจูุจ ุจูุงุกู ุนูู ุชุดุฎูุต ุงูุญุงูุฉ ูุงููููุน ุงูุฌุบุฑุงูู.</p>
    </div>
    ''', unsafe_allow_html=True)
    if st.button("ุงูุนูุฏุฉ ูููุญุต"):
        st.session_state.pg = "main"
        st.rerun()
